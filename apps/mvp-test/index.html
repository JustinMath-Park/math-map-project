<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Math Level Test</title>
    <!-- 1. Tailwind CSS ë¡œë“œ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 2. KaTeX (LaTeX ìˆ˜í•™ì‹ ë Œë”ëŸ¬) ë¡œë“œ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <!-- 3. Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAiL9H3NC8fd9Ket1bRz055TBpj3hlLPwg",
            authDomain: "my-mvp-backend.firebaseapp.com",
            projectId: "my-mvp-backend",
            storageBucket: "my-mvp-backend.firebasestorage.app",
            messagingSenderId: "1093137562151",
            appId: "1:1093137562151:web:ea01ce4daf632d0e64ac02"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);

        // URLì—ì„œ í† í° ì¶”ì¶œ ë° ìë™ ë¡œê·¸ì¸
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('token');
        const uid = urlParams.get('uid');

        if (token) {
            console.log('ğŸ”‘ Wixì—ì„œ ì „ë‹¬ë°›ì€ í† í°ìœ¼ë¡œ Firebase ë¡œê·¸ì¸ ì¤‘...');
            console.log(`   - UID: ${uid}`);

            signInWithCustomToken(auth, token)
                .then((userCredential) => {
                    console.log('âœ… Firebase ë¡œê·¸ì¸ ì„±ê³µ:', userCredential.user.uid);
                    // URLì—ì„œ í† í° ì œê±° (ë³´ì•ˆ)
                    window.history.replaceState(null, '', window.location.pathname);
                })
                .catch((error) => {
                    console.error('âŒ Firebase ë¡œê·¸ì¸ ì‹¤íŒ¨:', error);
                    alert('ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                });
        }

        // ì¸ì¦ ìƒíƒœ ê°ì‹œ
        onAuthStateChanged(auth, (user) => {
            if (user) {
                console.log('âœ… ë¡œê·¸ì¸ëœ ì‚¬ìš©ì:', user.uid);
                window.currentUser = user;
            } else {
                console.log('ğŸ‘¤ ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ìƒíƒœ');
            }
        });
    </script>
    <style>
        /* KaTeX í°íŠ¸ê°€ ì •ìƒ ë¡œë“œë˜ë„ë¡ ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
        body { font-family: 'Inter', sans-serif; }
        .katex { font-size: 1.25rem; } /* ìˆ˜í•™ì‹ í°íŠ¸ í¬ê¸° ì¡°ì • */

        /* íƒ€ì´ë¨¸ ìŠ¤íƒ€ì¼ */
        .timer-normal { color: #10b981; }
        .timer-warning { color: #f59e0b; }
        .timer-danger { color: #ef4444; animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ëª¨ë‹¬ ë°°ê²½ */
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- íƒ€ì´ë¨¸ (ê³ ì • ìœ„ì¹˜) -->
    <div id="timer-container" class="hidden fixed top-4 right-4 bg-white px-6 py-3 rounded-lg shadow-lg z-50">
        <div class="flex items-center gap-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span id="timer-display" class="text-xl font-bold timer-normal">30:00</span>
        </div>
    </div>

    <!-- ì‹œê°„ ì¢…ë£Œ ëª¨ë‹¬ -->
    <div id="timeout-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 shadow-2xl">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                    </svg>
                </div>
                <h3 class="text-lg font-medium text-gray-900 mb-2">ì‹œê°„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤</h3>
                <p class="text-sm text-gray-500 mb-6">ì œí•œ ì‹œê°„ 30ë¶„ì´ ê²½ê³¼í–ˆìŠµë‹ˆë‹¤. ê³„ì† í’€ì´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</p>
                <div class="flex gap-3">
                    <button id="submit-timeout-btn" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        ì§€ê¸ˆ ì œì¶œí•˜ê¸°
                    </button>
                    <button id="continue-btn" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition">
                        ê³„ì† í’€ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- AI ë¶„ì„ ë¡œë”© ëª¨ë‹¬ -->
    <div id="loading-modal" class="hidden fixed inset-0 modal-backdrop flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md mx-4 shadow-2xl">
            <div class="text-center">
                <div class="mx-auto flex items-center justify-center mb-6">
                    <svg class="animate-spin h-16 w-16 text-blue-600" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                </div>
                <h3 class="text-xl font-semibold text-gray-900 mb-2">AI ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</h3>
                <p class="text-sm text-gray-500">ë‹µì•ˆì„ ì œì¶œí•˜ê³  AIê°€ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤.<br>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.</p>
            </div>
        </div>
    </div>

    <div class="container mx-auto max-w-3xl p-6">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-blue-800">AI í…ŒìŠ¤íŠ¸ ê¸°ë°˜ ë§ì¶¤í˜• ë ˆë²¨ í…ŒìŠ¤íŠ¸</h1>
            <p class="text-lg text-gray-600 mt-2">ë‹¹ì‹ ì˜ ìˆ˜í•™ì  ì•½ì ì„ AIê°€ ì •í™•íˆ ì§„ë‹¨í•´ ë“œë¦½ë‹ˆë‹¤.</p>
        </header>

        <!-- Step 1: í…ŒìŠ¤íŠ¸ ì‹œì‘ -->
        <div id="start-section" class="text-center">
            <button id="start-test-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-blue-700 transition duration-300">
                ë ˆë²¨ í…ŒìŠ¤íŠ¸ ì‹œì‘í•˜ê¸°
            </button>
        </div>

        <!-- Step 2: ë¬¸ì œ í’€ì´ ì„¹ì…˜ (ì²˜ìŒì—” ìˆ¨ê²¨ì§) -->
        <div id="problem-section" class="hidden bg-white p-8 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-semibold mb-6 border-b pb-4">ë¬¸ì œ í’€ì´</h2>
            <div id="problem-container" class="space-y-8">
                <!-- JSê°€ DBì—ì„œ ê°€ì ¸ì˜¨ ë¬¸ì œë¥¼ ì—¬ê¸°ì— ì±„ì›ë‹ˆë‹¤ -->
            </div>
            <button id="submit-btn" class="mt-10 w-full bg-green-600 text-white font-bold py-3 rounded-lg shadow-lg hover:bg-green-700 transition duration-300">
                ë‹µì•ˆ ì œì¶œ ë° AI ë¶„ì„ ë°›ê¸°
            </button>
        </div>

        <!-- Step 3: ê²°ê³¼ ë¶„ì„ ì„¹ì…˜ (ì²˜ìŒì—” ìˆ¨ê²¨ì§) -->
        <div id="result-section" class="hidden bg-white p-8 rounded-xl shadow-2xl mt-10">
            <h2 class="text-3xl font-bold text-center text-blue-800 mb-6">AI ì§„ë‹¨ ë¦¬í¬íŠ¸</h2>
            
            <!-- 4.1. AI ì¢…í•© ì§„ë‹¨ (M4) -->
            <div id="ai-analysis-report" class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg mb-8">
                <h3 class="text-xl font-semibold text-blue-900 mb-2">ì¢…í•© ì§„ë‹¨</h3>
                <p class="text-base">AIê°€ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</p>
            </div>

            <!-- 4.2. ë¬¸í•­ë³„ í•´ì„¤ (M3) -->
            <div id="result-details" class="space-y-6">
                <h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ë¬¸í•­ë³„ ìƒì„¸ í•´ì„¤</h3>
                <!-- JSê°€ ì±„ì  ê²°ê³¼ ë° AI í•´ì„¤ì„ ì—¬ê¸°ì— ì±„ì›ë‹ˆë‹¤ -->
            </div>
        </div>

        <!-- ë¡œë”© ë° ì—ëŸ¬ ë©”ì‹œì§€ -->
        <div id="message-container" class="text-center p-4"></div>
    </div>

    <script>
        // Python ë°±ì—”ë“œ ì„œë²„ì˜ ì£¼ì†Œ
        const API_URL = 'https://my-mvp-backend-1093137562151.us-central1.run.app';

        // íƒ€ì´ë¨¸ ì„¤ì •
        const TIMER_CONFIG = {
            DURATION: 1800,      // 30ë¶„ = 1800ì´ˆ
            WARNING_TIME: 300,   // 5ë¶„ = 300ì´ˆ (ì£¼í™©ìƒ‰ ê²½ê³ )
            DANGER_TIME: 60      // 1ë¶„ = 60ì´ˆ (ë¹¨ê°„ìƒ‰ ê²½ê³ )
        };

        // ì „ì—­ ë³€ìˆ˜
        let loadedProblems = [];
        let timerState = {
            timeRemaining: TIMER_CONFIG.DURATION,
            startTime: null,
            intervalId: null,
            isOvertime: false
        };

        // DOM ìš”ì†Œ
        const startBtn = document.getElementById('start-test-btn');
        const startSection = document.getElementById('start-section');
        const problemSection = document.getElementById('problem-section');
        const problemContainer = document.getElementById('problem-container');
        const submitBtn = document.getElementById('submit-btn');
        const resultSection = document.getElementById('result-section');
        const analysisReportDiv = document.getElementById('ai-analysis-report');
        const resultDetailsDiv = document.getElementById('result-details');
        const messageDiv = document.getElementById('message-container');
        const timerContainer = document.getElementById('timer-container');
        const timerDisplay = document.getElementById('timer-display');
        const timeoutModal = document.getElementById('timeout-modal');
        const submitTimeoutBtn = document.getElementById('submit-timeout-btn');
        const continueBtn = document.getElementById('continue-btn');
        const loadingModal = document.getElementById('loading-modal');

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        startBtn.addEventListener('click', loadProblems);
        submitBtn.addEventListener('click', submitAnswers);
        submitTimeoutBtn.addEventListener('click', submitAnswers);
        continueBtn.addEventListener('click', hideTimeoutModal);

        // M2.1: Python ë°±ì—”ë“œì—ì„œ ë¬¸ì œ ë¡œë“œ (FIXED)
        async function loadProblems() {
            showMessage("ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...", "blue");
            startBtn.disabled = true;

            try {
                const response = await fetch(`${API_URL}/get_test_problems`);
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }

                loadedProblems = await response.json(); // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
                
                if (!loadedProblems || loadedProblems.length === 0) {
                    throw new Error("DBì—ì„œ ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. (ë°ì´í„°ê°€ ë¹„ì–´ìˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
                }

                displayProblems(); // ë¬¸ì œ í‘œì‹œ í•¨ìˆ˜ í˜¸ì¶œ

                startSection.classList.add('hidden'); // ì‹œì‘ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                problemSection.classList.remove('hidden'); // ë¬¸ì œ ì„¹ì…˜ í‘œì‹œ
                messageDiv.innerHTML = ''; // ë¡œë”© ë©”ì‹œì§€ ì œê±°

                // íƒ€ì´ë¨¸ ì‹œì‘
                startTimer();
                showTimer();

                // ë¬¸ì œ ì„¹ì…˜ìœ¼ë¡œ ìŠ¤í¬ë¡¤
                problemSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

            } catch (error) {
                console.error('Error loading problems:', error);
                showMessage(`ì˜¤ë¥˜: ë¬¸ì œ ë¡œë”© ì‹¤íŒ¨: ${error.message} (Python ì„œë²„ ì‹¤í–‰ ë° DB ì—°ê²°, Phase 1 ë°ì´í„° í™•ì¸)`, "red");
                startBtn.disabled = false;
            }
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer() {
            timerState.startTime = Date.now();
            timerState.intervalId = setInterval(() => {
                timerState.timeRemaining--;
                updateTimer();

                // ì‹œê°„ ì¢…ë£Œ ì‹œ ëª¨ë‹¬ í‘œì‹œ
                if (timerState.timeRemaining === 0 && !timerState.isOvertime) {
                    showTimeoutModal();
                }

                // ì´ˆê³¼ ì‹œê°„
                if (timerState.timeRemaining < 0) {
                    timerState.isOvertime = true;
                }
            }, 1000);
        }

        // íƒ€ì´ë¨¸ ì •ì§€
        function stopTimer() {
            if (timerState.intervalId) {
                clearInterval(timerState.intervalId);
                timerState.intervalId = null;
            }
        }

        // íƒ€ì´ë¨¸ í‘œì‹œ/ìˆ¨ê¹€
        function showTimer() {
            timerContainer.classList.remove('hidden');
        }

        function hideTimer() {
            timerContainer.classList.add('hidden');
        }

        // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
        function updateTimer() {
            const seconds = timerState.timeRemaining;
            const minutes = Math.floor(Math.abs(seconds) / 60);
            const secs = Math.abs(seconds) % 60;
            const sign = seconds < 0 ? '-' : '';

            timerDisplay.textContent = `${sign}${minutes}:${secs.toString().padStart(2, '0')}`;

            // ìƒ‰ìƒ ë³€ê²½
            timerDisplay.className = 'text-xl font-bold';
            if (seconds < 0) {
                timerDisplay.classList.add('timer-danger');
            } else if (seconds <= TIMER_CONFIG.DANGER_TIME) {
                timerDisplay.classList.add('timer-danger');
            } else if (seconds <= TIMER_CONFIG.WARNING_TIME) {
                timerDisplay.classList.add('timer-warning');
            } else {
                timerDisplay.classList.add('timer-normal');
            }
        }

        // ì‹œê°„ ì¢…ë£Œ ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
        function showTimeoutModal() {
            timeoutModal.classList.remove('hidden');
        }

        function hideTimeoutModal() {
            timeoutModal.classList.add('hidden');
        }

        // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ/ìˆ¨ê¹€
        function showLoadingModal() {
            loadingModal.classList.remove('hidden');
        }

        function hideLoadingModal() {
            loadingModal.classList.add('hidden');
        }

        // ì‹¤ì œ ì†Œìš” ì‹œê°„ ê³„ì‚°
        function getTotalTimeSpent() {
            if (!timerState.startTime) return 0;
            return Math.floor((Date.now() - timerState.startTime) / 1000);
        }

        // ë¡œë“œëœ ë¬¸ì œë¥¼ HTMLë¡œ í‘œì‹œ (FIXED for Fix 1 & 2)
        function displayProblems() {
            problemContainer.innerHTML = '';
            loadedProblems.forEach((problem, index) => {
                const problemEl = document.createElement('div');
                problemEl.className = 'border p-5 rounded-lg';
                problemEl.dataset.problemId = problem.problem_id; // id ì €ì¥

                // ë¬¸ì œ í…ìŠ¤íŠ¸ (Fix 1: innerHTML, Fix 2: text-gray-900)
                const textEl = document.createElement('div');
                textEl.className = 'problem-text mb-4 text-gray-900'; // 2. ê¸°ë³¸ ê²€ì •ìƒ‰
                
                // 1. innerHTMLë¡œ í…ìŠ¤íŠ¸ë¥¼ ë¨¼ì € ì„¤ì • (ë„ì–´ì“°ê¸° ë³´ì¡´)
                textEl.innerHTML = `<b>Q ${index + 1}.</b> ${problem.text_latex}`;

                // ì„ íƒì§€ (Radio Buttons)
                const choicesEl = document.createElement('div');
                choicesEl.className = 'choices space-y-2';
                
                // choicesê°€ ë°°ì—´ì¸ì§€ í™•ì¸
                if (Array.isArray(problem.choices)) {
                    problem.choices.forEach(choice => {
                        // "A) 4", "B) 9" ì—ì„œ "A", "4" ë˜ëŠ” "B", "9" ë¶„ë¦¬
                        const choiceMatch = choice.match(/^([A-D])\)\s*(.*)$/);
                        let choiceValue = choice;
                        let choiceLabel = choice;

                        if (choiceMatch) {
                            choiceValue = choiceMatch[1]; // "A"
                            choiceLabel = choice; // "A) 4"
                        }

                        choicesEl.innerHTML += `
                            <label class="block flex items-center p-3 rounded-md border hover:bg-gray-50 cursor-pointer">
                                <input type="radio" name="problem-${problem.problem_id}" value="${choiceValue}" class="mr-3">
                                <span class="choice-text">${choiceLabel}</span>
                            </label>
                        `;
                    });
                } else if (problem.choices === 'ì£¼ê´€ì‹') {
                     choicesEl.innerHTML = `
                        <label class="block">
                            <span class="text-gray-700">ì£¼ê´€ì‹ ë‹µ:</span>
                            <input type="text" name="problem-${problem.problem_id}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500">
                        </label>
                    `;
                }

                problemEl.appendChild(textEl);
                problemEl.appendChild(choicesEl);
                problemContainer.appendChild(problemEl);

                // 2. KaTeX ë Œë”ë§: '$' ê¸°í˜¸ê°€ í¬í•¨ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰ (ê¸°ì¡´ í—¬í¼ í•¨ìˆ˜ ì‚¬ìš©)
                renderKatexInElements([textEl]); // ë¬¸ì œ í…ìŠ¤íŠ¸ ë Œë”ë§
            });

            // ì„ íƒì§€ ë‚´ë¶€ì˜ LaTeXë„ ë Œë”ë§
            renderKatexInElements(problemContainer.querySelectorAll('.choice-text'));
        }

        // M3 & M4: ë‹µì•ˆ ì œì¶œ ë° AI ë¶„ì„ ìš”ì²­
        async function submitAnswers() {
            // ë¡œë”© ëª¨ë‹¬ í‘œì‹œ
            showLoadingModal();
            submitBtn.disabled = true;
            submitTimeoutBtn.disabled = true;

            // íƒ€ì´ë¨¸ ì •ì§€
            stopTimer();
            hideTimer();
            hideTimeoutModal();

            // ì‚¬ìš©ì ì¸ì¦ í™•ì¸ (ê²ŒìŠ¤íŠ¸ ëª¨ë“œ ì§€ì›)
            const userId = window.currentUser ? window.currentUser.uid : `guest_${Date.now()}`;
            const isGuest = !window.currentUser;

            // 1. í•™ìƒ ë‹µì•ˆ ìˆ˜ì§‘
            const userAnswers = [];
            loadedProblems.forEach(problem => {
                const problemId = problem.problem_id;
                // Radio ë˜ëŠ” Text Input ì°¾ê¸°
                const inputEl = document.querySelector(`input[name="problem-${problemId}"]:checked, input[type="text"][name="problem-${problemId}"]`);
                userAnswers.push({
                    problem_id: problemId,
                    user_answer: inputEl ? inputEl.value : null // ì„ íƒ ì•ˆí•˜ë©´ null
                });
            });

            // ì‹œê°„ ì •ë³´ ìˆ˜ì§‘
            const totalTimeSpent = getTotalTimeSpent();
            const isOvertime = totalTimeSpent > TIMER_CONFIG.DURATION;

            // 2. Python ë°±ì—”ë“œë¡œ ì „ì†¡
            try {
                const response = await fetch(`${API_URL}/submit_and_analyze`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: userId,  // ë¡œê·¸ì¸ ì‚¬ìš©ì ë˜ëŠ” ê²ŒìŠ¤íŠ¸ ID
                        is_guest: isGuest,  // ê²ŒìŠ¤íŠ¸ ì—¬ë¶€
                        answers: userAnswers,
                        test_type: 'level_test',
                        grade: null,  // TODO: ì‚¬ìš©ì í”„ë¡œí•„ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                        curriculum_category: null,
                        target_difficulty: 'Medium',
                        total_time_spent: totalTimeSpent,
                        time_limit: TIMER_CONFIG.DURATION,
                        is_overtime: isOvertime
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || `ì„œë²„ ì˜¤ë¥˜: ${response.status}`);
                }

                const data = await response.json();

                // ë¡œë”© ëª¨ë‹¬ ìˆ¨ê¹€
                hideLoadingModal();

                // 3. ê²°ê³¼ í‘œì‹œ
                displayResults(data);
                problemSection.classList.add('hidden');
                resultSection.classList.remove('hidden');
                messageDiv.innerHTML = ''; // ì„±ê³µ

            } catch (error) {
                console.error('Error submitting answers:', error);
                hideLoadingModal();
                showMessage(`ì˜¤ë¥˜: ${error.message} (Python ì„œë²„ ë¡œì§ í™•ì¸)`, "red");
                submitBtn.disabled = false;
            }
        }

        // ê²°ê³¼ í˜ì´ì§€ í‘œì‹œ
        function displayResults(data) {
            // M4: AI ì¢…í•© ë¶„ì„
            analysisReportDiv.innerHTML = `
                <h3 class="text-xl font-semibold text-blue-900 mb-2">ì¢…í•© ì§„ë‹¨</h3>
                <p class="text-base">${data.ai_analysis_report || "AI ë¶„ì„ ë¦¬í¬íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."}</p>
            `;

            // M3: ë¬¸í•­ë³„ í•´ì„¤
            resultDetailsDiv.innerHTML = '<h3 class="text-xl font-semibold text-gray-800 mb-4 border-b pb-2">ë¬¸í•­ë³„ ìƒì„¸ í•´ì„¤</h3>';
            data.test_results.forEach((result, index) => {
                const isCorrect = result.is_correct;
                const resultEl = document.createElement('div');
                resultEl.className = `p-5 rounded-lg border-l-4 ${isCorrect ? 'border-green-500 bg-green-50' : 'border-red-500 bg-red-50'}`;
                
                let html = '';
                
                // ë¬¸ì œ í…ìŠ¤íŠ¸ (ë Œë”ë§ í•„ìš” ì—†ìŒ - í—¬í¼ í•¨ìˆ˜ê°€ ì²˜ë¦¬)
                const problemTextHtml = `<b>Q ${index + 1}.</b> ${result.text_latex}`;
                
                if (isCorrect) {
                    html = `
                        <h4 class="text-lg font-semibold text-green-800">ë¬¸ì œ ${index + 1}: ì •ë‹µ <span class="font-bold">âœ“</span></h4>
                        <div class="problem-text-result mt-2">${problemTextHtml}</div>
                        <p class="mt-2 text-green-700"><b>ì •ë‹µ:</b> ${result.correct_answer}</p>
                    `;
                } else {
                    // M3: AI í•´ì„¤
                    html = `
                        <h4 class="text-lg font-semibold text-red-800">ë¬¸ì œ ${index + 1}: ì˜¤ë‹µ <span class="font-bold">âœ—</span></h4>
                        <div class="problem-text-result mt-2">${problemTextHtml}</div>
                        <p class="mt-2 text-red-700"><b>ë‚´ ë‹µì•ˆ:</b> ${result.user_answer || 'ë¯¸ì œì¶œ'} | <b>ì •ë‹µ:</b> ${result.correct_answer}</p>
                        <div class="mt-4 pt-4 border-t border-red-200">
                            <h5 class="font-semibold text-red-900 mb-2">AI íŠœí„°ì˜ í•´ì„¤</h5>
                            <!--
                                [ìµœì¢… ë²„ê·¸ ìˆ˜ì •]
                                ì„œë²„ê°€ ë³´ë‚´ëŠ” í‚¤ëŠ” 'ai_solution'ì…ë‹ˆë‹¤.
                                'ai_explanation'ì„ 'ai_solution'ìœ¼ë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
                            -->
                            <div class="ai-explanation text-gray-700">${result.ai_solution || "í•´ì„¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."}</div>
                        </div>
                    `;
                }
                resultEl.innerHTML = html;
                resultDetailsDiv.appendChild(resultEl);
            });
            
            // ê²°ê³¼ í˜ì´ì§€ì˜ ëª¨ë“  ë¬¸ì œ í…ìŠ¤íŠ¸ì™€ AI í•´ì„¤ì— KaTeX ë Œë”ë§
            renderKatexInElements(resultDetailsDiv.querySelectorAll('.problem-text-result'));
            renderKatexInElements(resultDetailsDiv.querySelectorAll('.ai-explanation'));
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ ìœ í‹¸ë¦¬í‹°
        function showMessage(message, color) {
            messageDiv.innerHTML = `<p class="text-${color}-600 font-semibold">${message}</p>`;
        }
        
        // ì—¬ëŸ¬ ìš”ì†Œì— KaTeXë¥¼ í•œ ë²ˆì— ì ìš©í•˜ëŠ” í—¬í¼
        function renderKatexInElements(elements) {
            elements.forEach(el => {
                try {
                    // KaTeXëŠ” $$...$$ (display) ì™€ $...$ (inline)ì„ ì§€ì›í•˜ì§€ ì•ŠìŒ.
                    // replaceAllì„ ì‚¬ìš©í•˜ì—¬ ìˆ˜ë™ìœ¼ë¡œ ë Œë”ë§ íŠ¸ë¦¬ê±°
                    let text = el.innerHTML;
                    
                    // Display mode ($$)
                    text = text.replace(/\$\$([\s\S]*?)\$\$/g, (match, latex) => {
                        return katex.renderToString(latex, { displayMode: true, throwOnError: false });
                    });
                    
                    // Inline mode ($)
                    text = text.replace(/\$([\s\S]*?)\$/g, (match, latex) => {
                        return katex.renderToString(latex, { displayMode: false, throwOnError: false });
                    });

                    el.innerHTML = text;
                } catch (e) {
                    console.warn("Katex rendering error", e);
                }
            });
        }

    </script>
</body>
</html>
